name:DeployFrontend(Vercel)

on:
workflow_run:
workflows:['CIPipeline']
types:[completed]
branches:[main]

concurrency:
group:deploy-vercel-${{github.ref}}
cancel-in-progress:false

env:
NODE_VERSION:'20'
DEPLOY_COOLDOWN_HOURS:3

jobs:
#===========================================
#VERIFYCIPASSED
#===========================================
verify-ci:
name:âœ…VerifyCIPassed
runs-on:ubuntu-latest
if:github.event.workflow_run.conclusion=='success'
steps:
-name:CIVerification
run:|
echo"##âœ…CIPipelinePassed">>$GITHUB_STEP_SUMMARY
echo"ProceedingwithVerceldeployments...">>$GITHUB_STEP_SUMMARY

#===========================================
#DETECTCHANGES
#===========================================
detect-changes:
name:ðŸ”DetectChanges
runs-on:ubuntu-latest
needs:verify-ci
outputs:
apps-admin:${{steps.filter.outputs.apps-admin}}
apps-seller:${{steps.filter.outputs.apps-seller}}
apps-shell:${{steps.filter.outputs.apps-shell}}
packages:${{steps.filter.outputs.packages}}
steps:
-uses:actions/checkout@v4
with:
ref:${{github.event.workflow_run.head_sha}}
fetch-depth:2

-uses:dorny/paths-filter@v3
id:filter
with:
filters:|
apps-admin:
-'apps/admin-app/**'
-'packages/**'
apps-seller:
-'apps/seller-app/**'
-'packages/**'
apps-shell:
-'apps/shell-app/**'
-'packages/**'
packages:
-'packages/**'

#===========================================
#VALIDATESECRETS
#===========================================
validate-secrets:
name:ðŸ”ValidateSecrets
runs-on:ubuntu-latest
needs:detect-changes
steps:
-name:CheckRequiredSecrets
env:
HAS_VERCEL_ORG:${{secrets.VERCEL_ORG_ID!=''}}
HAS_VERCEL_TOKEN:${{secrets.VERCEL_TOKEN!=''}}
HAS_ADMIN_PROJECT:${{secrets.VERCEL_PROJECT_ID_ADMIN!=''}}
HAS_SELLER_PROJECT:${{secrets.VERCEL_PROJECT_ID_SELLER!=''}}
HAS_SHELL_PROJECT:${{secrets.VERCEL_PROJECT_ID_SHELL!=''}}
run:|
missing=""
if["$HAS_VERCEL_ORG"!="true"];thenmissing="$missingVERCEL_ORG_ID";fi
if["$HAS_VERCEL_TOKEN"!="true"];thenmissing="$missingVERCEL_TOKEN";fi
if["$HAS_ADMIN_PROJECT"!="true"];thenmissing="$missingVERCEL_PROJECT_ID_ADMIN";fi
if["$HAS_SELLER_PROJECT"!="true"];thenmissing="$missingVERCEL_PROJECT_ID_SELLER";fi
if["$HAS_SHELL_PROJECT"!="true"];thenmissing="$missingVERCEL_PROJECT_ID_SHELL";fi

if[-n"$missing"];then
echo"âŒMissingrequiredsecrets:$missing">>$GITHUB_STEP_SUMMARY
exit1
fi

echo"âœ…Allrequiredsecretsareconfigured">>$GITHUB_STEP_SUMMARY

#===========================================
#DEPLOYADMINAPP
#===========================================
deploy-admin:
name:ðŸš€DeployAdminApp
runs-on:ubuntu-latest
needs:[detect-changes,validate-secrets]
if:needs.detect-changes.outputs.apps-admin=='true'
steps:
-uses:actions/checkout@v4
with:
ref:${{github.event.workflow_run.head_sha}}

-name:RestoreDeployState
id:restore-state
uses:actions/cache/restore@v4
with:
path:.deploy-state-admin
key:deploy-state-admin-
restore-keys:deploy-state-admin-

-name:CheckCooldownandLastStatus
id:check-cooldown
run:|
should_deploy="true"

if[-f.deploy-state-admin];then
last_deploy=$(sed-n'1p'.deploy-state-admin)
last_status=$(sed-n'2p'.deploy-state-admin)
current_time=$(date+%s)
diff=$((current_time-last_deploy))
cooldown_seconds=$((${{env.DEPLOY_COOLDOWN_HOURS}}*3600))

echo"Lastdeploy:$((diff/60))minutesago,status:$last_status"

#Deployif:lastfailedORolderthancooldown
if["$last_status"="success"]&&[$diff-lt$cooldown_seconds];then
remaining=$(((cooldown_seconds-diff)/60))
echo"â³Deploycooldownactive.Lastsuccessfuldeploywas$((diff/60))minutesago.Wait$remainingmoreminutes.">>$GITHUB_STEP_SUMMARY
should_deploy="false"
elif["$last_status"="failed"];then
echo"ðŸ”„Lastdeployfailed,retrying...">>$GITHUB_STEP_SUMMARY
fi
fi

echo"deploy=$should_deploy">>$GITHUB_OUTPUT

-name:SetupNode.js
if:steps.check-cooldown.outputs.deploy=='true'
uses:actions/setup-node@v4
with:
node-version:${{env.NODE_VERSION}}
cache:'yarn'

-name:Installdependencies
if:steps.check-cooldown.outputs.deploy=='true'
run:yarninstall--frozen-lockfile

-name:Buildpackages
if:steps.check-cooldown.outputs.deploy=='true'
run:|
yarnbuild:types
yarnbuild:utils
yarnbuild:storybook

-name:InstallVercelCLI
if:steps.check-cooldown.outputs.deploy=='true'
run:npminstall--globalvercel@latest

-name:PullVercelConfig
if:steps.check-cooldown.outputs.deploy=='true'
run:vercelpull--yes--environment=production--token=${{secrets.VERCEL_TOKEN}}
env:
VERCEL_ORG_ID:${{secrets.VERCEL_ORG_ID}}
VERCEL_PROJECT_ID:${{secrets.VERCEL_PROJECT_ID_ADMIN}}

-name:BuildAdminApp
if:steps.check-cooldown.outputs.deploy=='true'
run:vercelbuild--prod--token=${{secrets.VERCEL_TOKEN}}
env:
VERCEL_ORG_ID:${{secrets.VERCEL_ORG_ID}}
VERCEL_PROJECT_ID:${{secrets.VERCEL_PROJECT_ID_ADMIN}}

-name:DeploytoVercel
if:steps.check-cooldown.outputs.deploy=='true'
id:deploy
run:|
url=$(verceldeploy--prebuilt--prod--token=${{secrets.VERCEL_TOKEN}})
echo"url=$url">>$GITHUB_OUTPUT
echo"###ðŸš€AdminAppDeployed">>$GITHUB_STEP_SUMMARY
echo"**URL:**$url">>$GITHUB_STEP_SUMMARY
env:
VERCEL_ORG_ID:${{secrets.VERCEL_ORG_ID}}
VERCEL_PROJECT_ID:${{secrets.VERCEL_PROJECT_ID_ADMIN}}

-name:SaveDeployState(Success)
if:steps.check-cooldown.outputs.deploy=='true'&&success()
run:|
echo"$(date+%s)">.deploy-state-admin
echo"success">>.deploy-state-admin

-name:SaveDeployState(Failed)
if:steps.check-cooldown.outputs.deploy=='true'&&failure()
run:|
echo"$(date+%s)">.deploy-state-admin
echo"failed">>.deploy-state-admin

-name:CacheDeployState
if:steps.check-cooldown.outputs.deploy=='true'&&always()
uses:actions/cache/save@v4
with:
path:.deploy-state-admin
key:deploy-state-admin-${{github.run_id}}

#===========================================
#DEPLOYSELLERAPP
#===========================================
deploy-seller:
name:ðŸš€DeploySellerApp
runs-on:ubuntu-latest
needs:[detect-changes,validate-secrets]
if:needs.detect-changes.outputs.apps-seller=='true'
steps:
-uses:actions/checkout@v4
with:
ref:${{github.event.workflow_run.head_sha}}

-name:RestoreDeployState
id:restore-state
uses:actions/cache/restore@v4
with:
path:.deploy-state-seller
key:deploy-state-seller-
restore-keys:deploy-state-seller-

-name:CheckCooldownandLastStatus
id:check-cooldown
run:|
should_deploy="true"

if[-f.deploy-state-seller];then
last_deploy=$(sed-n'1p'.deploy-state-seller)
last_status=$(sed-n'2p'.deploy-state-seller)
current_time=$(date+%s)
diff=$((current_time-last_deploy))
cooldown_seconds=$((${{env.DEPLOY_COOLDOWN_HOURS}}*3600))

echo"Lastdeploy:$((diff/60))minutesago,status:$last_status"

if["$last_status"="success"]&&[$diff-lt$cooldown_seconds];then
remaining=$(((cooldown_seconds-diff)/60))
echo"â³Deploycooldownactive.Lastsuccessfuldeploywas$((diff/60))minutesago.Wait$remainingmoreminutes.">>$GITHUB_STEP_SUMMARY
should_deploy="false"
elif["$last_status"="failed"];then
echo"ðŸ”„Lastdeployfailed,retrying...">>$GITHUB_STEP_SUMMARY
fi
fi

echo"deploy=$should_deploy">>$GITHUB_OUTPUT

-name:SetupNode.js
if:steps.check-cooldown.outputs.deploy=='true'
uses:actions/setup-node@v4
with:
node-version:${{env.NODE_VERSION}}
cache:'yarn'

-name:Installdependencies
if:steps.check-cooldown.outputs.deploy=='true'
run:yarninstall--frozen-lockfile

-name:Buildpackages
if:steps.check-cooldown.outputs.deploy=='true'
run:|
yarnbuild:types
yarnbuild:utils
yarnbuild:storybook

-name:InstallVercelCLI
if:steps.check-cooldown.outputs.deploy=='true'
run:npminstall--globalvercel@latest

-name:PullVercelConfig
if:steps.check-cooldown.outputs.deploy=='true'
run:vercelpull--yes--environment=production--token=${{secrets.VERCEL_TOKEN}}
env:
VERCEL_ORG_ID:${{secrets.VERCEL_ORG_ID}}
VERCEL_PROJECT_ID:${{secrets.VERCEL_PROJECT_ID_SELLER}}

-name:BuildSellerApp
if:steps.check-cooldown.outputs.deploy=='true'
run:vercelbuild--prod--token=${{secrets.VERCEL_TOKEN}}
env:
VERCEL_ORG_ID:${{secrets.VERCEL_ORG_ID}}
VERCEL_PROJECT_ID:${{secrets.VERCEL_PROJECT_ID_SELLER}}

-name:DeploytoVercel
if:steps.check-cooldown.outputs.deploy=='true'
id:deploy
run:|
url=$(verceldeploy--prebuilt--prod--token=${{secrets.VERCEL_TOKEN}})
echo"url=$url">>$GITHUB_OUTPUT
echo"###ðŸš€SellerAppDeployed">>$GITHUB_STEP_SUMMARY
echo"**URL:**$url">>$GITHUB_STEP_SUMMARY
env:
VERCEL_ORG_ID:${{secrets.VERCEL_ORG_ID}}
VERCEL_PROJECT_ID:${{secrets.VERCEL_PROJECT_ID_SELLER}}

-name:SaveDeployState(Success)
if:steps.check-cooldown.outputs.deploy=='true'&&success()
run:|
echo"$(date+%s)">.deploy-state-seller
echo"success">>.deploy-state-seller

-name:SaveDeployState(Failed)
if:steps.check-cooldown.outputs.deploy=='true'&&failure()
run:|
echo"$(date+%s)">.deploy-state-seller
echo"failed">>.deploy-state-seller

-name:CacheDeployState
if:steps.check-cooldown.outputs.deploy=='true'&&always()
uses:actions/cache/save@v4
with:
path:.deploy-state-seller
key:deploy-state-seller-${{github.run_id}}

#===========================================
#DEPLOYSHELLAPP(ALWAYSDEPLOYS)
#===========================================
deploy-shell:
name:ðŸš€DeployShellApp(Always)
runs-on:ubuntu-latest
needs:[validate-secrets]
steps:
-uses:actions/checkout@v4
with:
ref:${{github.event.workflow_run.head_sha}}

-name:SetupNode.js
uses:actions/setup-node@v4
with:
node-version:${{env.NODE_VERSION}}
cache:'yarn'

-name:Installdependencies
run:yarninstall--frozen-lockfile

-name:Buildpackages
run:|
yarnbuild:types
yarnbuild:utils
yarnbuild:storybook

-name:InstallVercelCLI
run:npminstall--globalvercel@latest

-name:PullVercelConfig
run:vercelpull--yes--environment=production--token=${{secrets.VERCEL_TOKEN}}
env:
VERCEL_ORG_ID:${{secrets.VERCEL_ORG_ID}}
VERCEL_PROJECT_ID:${{secrets.VERCEL_PROJECT_ID_SHELL}}

-name:BuildShellApp
run:vercelbuild--prod--token=${{secrets.VERCEL_TOKEN}}
env:
VERCEL_ORG_ID:${{secrets.VERCEL_ORG_ID}}
VERCEL_PROJECT_ID:${{secrets.VERCEL_PROJECT_ID_SHELL}}

-name:DeploytoVercel
id:deploy
run:|
url=$(verceldeploy--prebuilt--prod--token=${{secrets.VERCEL_TOKEN}})
echo"url=$url">>$GITHUB_OUTPUT
echo"###ðŸš€ShellAppDeployed">>$GITHUB_STEP_SUMMARY
echo"**URL:**$url">>$GITHUB_STEP_SUMMARY
env:
VERCEL_ORG_ID:${{secrets.VERCEL_ORG_ID}}
VERCEL_PROJECT_ID:${{secrets.VERCEL_PROJECT_ID_SHELL}}

#===========================================
#DEPLOYMENTSUMMARY
#===========================================
deployment-summary:
name:ðŸ“ŠDeploymentSummary
runs-on:ubuntu-latest
needs:[detect-changes,deploy-admin,deploy-seller,deploy-shell]
if:always()
steps:
-name:GenerateSummary
run:|
echo"##ðŸ“ŠVercelDeploymentSummary">>$GITHUB_STEP_SUMMARY
echo"">>$GITHUB_STEP_SUMMARY
echo"###ChangesDetected">>$GITHUB_STEP_SUMMARY
echo"|App|Changed|">>$GITHUB_STEP_SUMMARY
echo"|-----|---------|">>$GITHUB_STEP_SUMMARY
echo"|Admin|${{needs.detect-changes.outputs.apps-admin}}|">>$GITHUB_STEP_SUMMARY
echo"|Seller|${{needs.detect-changes.outputs.apps-seller}}|">>$GITHUB_STEP_SUMMARY
echo"|Shell|Always|">>$GITHUB_STEP_SUMMARY
echo"">>$GITHUB_STEP_SUMMARY
echo"###DeploymentStatus">>$GITHUB_STEP_SUMMARY
echo"|App|Status|">>$GITHUB_STEP_SUMMARY
echo"|-----|--------|">>$GITHUB_STEP_SUMMARY
echo"|Admin|${{needs.deploy-admin.result}}|">>$GITHUB_STEP_SUMMARY
echo"|Seller|${{needs.deploy-seller.result}}|">>$GITHUB_STEP_SUMMARY
echo"|Shell(Always)|${{needs.deploy-shell.result}}|">>$GITHUB_STEP_SUMMARY

if["${{needs.deploy-admin.result}}"=="failure"]||\
["${{needs.deploy-seller.result}}"=="failure"]||\
["${{needs.deploy-shell.result}}"=="failure"];then
echo"">>$GITHUB_STEP_SUMMARY
echo"âŒ**Somedeploymentsfailed**">>$GITHUB_STEP_SUMMARY
exit1
fi

echo"">>$GITHUB_STEP_SUMMARY
echo"âœ…**Verceldeploymentworkflowcompleted**">>$GITHUB_STEP_SUMMARY
